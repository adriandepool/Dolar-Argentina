<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolar Hoy en Argentina</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
            max-width: 900px;
            margin: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-5xl font-bold text-cyan-400 mb-2">Dolar Hoy en Argentina</h1>
            <p class="text-gray-400">Cotizaciones del dólar actualizadas en tiempo real.</p>
        </header>

        <main id="cards-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-12">
            <div id="loading-cards" class="md:col-span-3 text-center text-gray-400 py-10">
                <svg class="animate-spin h-8 w-8 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Cargando cotizaciones...</p>
            </div>
        </main>
        
        <section class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-2xl border border-gray-700 mb-8 md:mb-12">
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-center">Evolución Dólar Blue (Últimos 30 días)</h2>
            <div id="loading-chart-daily" class="text-center text-gray-400 py-10">
                 <svg class="animate-spin h-8 w-8 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Cargando datos históricos diarios...</p>
            </div>
            <div class="chart-container" id="chart-wrapper-daily" style="display: none;">
                <canvas id="dolarChartDaily"></canvas>
            </div>
        </section>

        <section class="bg-gray-800 p-4 md:p-6 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-center">Evolución Mensual Dólar Blue (Último Año)</h2>
            <div id="loading-chart-monthly" class="text-center text-gray-400 py-10">
                 <svg class="animate-spin h-8 w-8 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Cargando datos históricos mensuales...</p>
            </div>
            <div class="chart-container" id="chart-wrapper-monthly" style="display: none;">
                <canvas id="dolarChartMonthly"></canvas>
            </div>
        </section>

    </div>

    <script>
        const cardsContainer = document.getElementById('cards-container');
        const loadingCards = document.getElementById('loading-cards');
        const loadingChartDaily = document.getElementById('loading-chart-daily');
        const chartWrapperDaily = document.getElementById('chart-wrapper-daily');
        const chartCanvasDaily = document.getElementById('dolarChartDaily');
        let dolarChartDailyInstance = null;
        const loadingChartMonthly = document.getElementById('loading-chart-monthly');
        const chartWrapperMonthly = document.getElementById('chart-wrapper-monthly');
        const chartCanvasMonthly = document.getElementById('dolarChartMonthly');
        let dolarChartMonthlyInstance = null;

        function formatCurrency(value) {
            if (value === null || typeof value === 'undefined') return 'No disponible';
            return value.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        const formatDateForApi = (date) => {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        async function fetchDolarData() {
            try {
                const response = await fetch('https://dolarapi.com/v1/dolares');
                if (!response.ok) throw new Error('Error al obtener cotizaciones.');
                const data = await response.json();
                cardsContainer.innerHTML = '';
                const filteredData = data.filter(dolar => dolar.casa !== 'tarjeta');
                filteredData.forEach(dolar => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 transform hover:scale-105 transition-transform duration-300 flex flex-col';
                    card.innerHTML = `<h2 class="text-xl font-bold text-cyan-400 capitalize">${dolar.nombre}</h2><div class="mt-4 text-lg flex-grow"><p class="text-gray-300">Compra: <span class="font-semibold text-green-400">${formatCurrency(dolar.compra)}</span></p><p class="text-gray-300">Venta: <span class="font-semibold text-red-400">${formatCurrency(dolar.venta)}</span></p></div><p class="text-xs text-gray-500 mt-4">Actualizado: ${formatDate(dolar.fechaActualizacion)}</p>`;
                    cardsContainer.appendChild(card);
                });
            } catch (error) {
                console.error("Error en fetchDolarData:", error);
                cardsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">No se pudieron cargar las cotizaciones.</p>`;
            } finally {
                if (loadingCards) loadingCards.style.display = 'none';
            }
        }

        async function fetchDailyChartData() {
            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 30);
                const apiUrl = `https://mercados.ambito.com/dolar/informal/historico-general/${formatDateForApi(startDate)}/${formatDateForApi(endDate)}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Error en API de Ámbito (diario).');
                let data = await response.json();
                
                data.shift();

                const labels = [];
                const prices = [];

                data.forEach(item => {
                    const dateStr = item[0];
                    const priceStr = item[2]; // Corregido: Usar el precio de venta (índice 2)
                    // La API de Ámbito puede devolver la fecha con '-' o con '/'.
                    if (typeof dateStr === 'string' && (dateStr.includes('-') || dateStr.includes('/')) && typeof priceStr === 'string') {
                        labels.push(dateStr);
                        prices.push(parseFloat(priceStr.replace(',', '.')));
                    }
                });

                labels.reverse();
                prices.reverse();

                if (labels.length > 0) {
                    createDailyChart(labels, prices);
                } else {
                    throw new Error("No se encontraron datos válidos para el gráfico diario.");
                }

            } catch (error) {
                console.error("Error en fetchDailyChartData:", error);
                loadingChartDaily.innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el gráfico diario.</p>`;
            } finally {
                loadingChartDaily.style.display = 'none';
                chartWrapperDaily.style.display = 'block';
            }
        }
        
        async function fetchMonthlyChartData() {
            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(endDate.getFullYear() - 1);
                const apiUrl = `https://mercados.ambito.com/dolar/informal/historico-general/${formatDateForApi(startDate)}/${formatDateForApi(endDate)}`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('La API mensual no respondió correctamente.');
                
                let data = await response.json();
                data.shift(); 

                // console.log("Datos mensuales crudos de la API:", data); // Descomentar para depuración profunda

                // Procesamos los datos diarios para agruparlos por mes y calcular el promedio.
                const monthlyData = data.reduce((acc, item) => {
                    // Verificación de seguridad para cada registro de la API.
                    if (!Array.isArray(item) || item.length < 3 || typeof item[0] !== 'string' || typeof item[2] !== 'string') {
                        console.warn("Item de dato inválido, omitiendo:", item);
                        return acc; 
                    }
                    
                    const dateStr = item[0]; // Formato: "DD-MM-YYYY"
                    const priceStr = item[2]; // Precio de venta
                    // La API de Ámbito puede devolver la fecha con '-' o con '/', así que usamos una regex para el split.
                    const parts = dateStr.split(/[-/]/);

                    // Aseguramos que la fecha tenga el formato esperado.
                    if (parts.length === 3) {
                        const day = parts[0];
                        const month = parts[1];
                        const year = parts[2];
                        
                        // Creamos una clave única para cada mes en el formato "YYYY-MM".
                        const key = `${year}-${month}`;
                        const value = parseFloat(priceStr.replace(',', '.'));

                        // Si el valor es un número válido, lo agregamos a nuestro acumulador.
                        if (!isNaN(value)) {
                            if (!acc[key]) {
                                acc[key] = { sum: 0, count: 0, monthName: '' };
                            }
                            acc[key].sum += value;
                            acc[key].count++;
                        } else {
                            console.warn(`Valor de precio no válido para la fecha ${dateStr}:`, priceStr);
                        }
                    } else {
                        console.warn(`Formato de fecha inesperado, omitiendo: ${dateStr}`);
                    }
                    return acc;
                }, {});
                
                // console.log("Datos procesados y agrupados por mes:", monthlyData); // Descomentar para depuración

                // Ordenamos las claves (YYYY-MM) para que el gráfico se muestre en orden cronológico.
                const sortedKeys = Object.keys(monthlyData).sort();

                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                const labels = sortedKeys.map(key => {
                    const [year, month] = key.split('-');
                    const monthIndex = parseInt(month, 10) - 1;
                    const monthName = monthNames[monthIndex];
                    const shortYear = year.slice(-2);
                    return `${monthName} '${shortYear}`;
                });
                
                // Calculamos el precio promedio para cada mes.
                const prices = sortedKeys.map(key => monthlyData[key].sum / monthlyData[key].count);

                // Si tenemos datos, creamos el gráfico. Si no, lanzamos un error.
                if (labels.length > 0) {
                    createMonthlyChart(labels, prices);
                } else {
                    throw new Error("No se generaron datos para el gráfico mensual después del procesamiento.");
                }

            } catch (error) {
                console.error("Error en fetchMonthlyChartData:", error);
                loadingChartMonthly.innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el gráfico mensual.</p>`;
            } finally {
                loadingChartMonthly.style.display = 'none';
                chartWrapperMonthly.style.display = 'block';
            }
        }

        function createDailyChart(labels, data) {
            const ctx = chartCanvasDaily.getContext('2d');
            if (dolarChartDailyInstance) dolarChartDailyInstance.destroy();
            dolarChartDailyInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor de Venta Dólar Blue',
                        data: data,
                        borderColor: 'rgb(34, 211, 238)',
                        backgroundColor: 'rgba(34, 211, 238, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgb(34, 211, 238)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: commonChartOptions(true)
            });
        }
        
        function createMonthlyChart(labels, data) {
             const ctx = chartCanvasMonthly.getContext('2d');
            if (dolarChartMonthlyInstance) dolarChartMonthlyInstance.destroy();
            dolarChartMonthlyInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Promedio Mensual Venta Dólar Blue',
                        data: data,
                        borderColor: 'rgb(34, 211, 238)',
                        backgroundColor: 'rgba(34, 211, 238, 0.5)',
                        borderWidth: 1
                    }]
                },
                options: commonChartOptions(false)
            });
        }
        
        function commonChartOptions(isDailyChart) {
             return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { color: '#9ca3af', callback: value => '$' + value },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) {
                                const label = this.getLabelForValue(value);
                                if (isDailyChart && typeof label === 'string') {
                                    // La fecha puede venir con '-' o '/', usamos una regex para ser flexibles.
                                    const parts = label.split(/[-/]/);
                                    if(parts.length === 3) return `${parts[0]}/${parts[1]}`;
                                }
                                return label;
                            }
                        },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#d1d5db' } },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label || '';
                            },
                            label: function(context) {
                                return formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchDolarData();
            fetchDailyChartData();
            fetchMonthlyChartData();
        });
    </script>
</body>
</html>
